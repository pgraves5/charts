suite: test rsyslog
templates:
  - syslog.yaml
tests:
  - it: should render nothing if not enabled
    set:
      sylogReceiver.create: false
    asserts:
      - hasDocuments:
          count: 0
  - it: should create a deployment
    set:
      logReceiver.create: true
    asserts:
      - isKind:
          of: Deployment
        documentIndex: 0
  - it: should create a service
    set:
      logReceiver.create: true
    asserts:
      - isKind:
          of: Service
        documentIndex: 1
  - it: should create a configmap
    set:
      logReceiver.create: true
    asserts:
      - isKind:
          of: ConfigMap
        documentIndex: 2
  - it: should exclude the pvc if persistence is disabled
    set:
      logReceiver.create: true
      logReceiver.persistence.enabled: false
    asserts:
      - hasDocuments:
          count: 3
  - it: should include the pvc if persistence is enabled
    set:
      logReceiver.create: true
      logReceiver.persistence.enabled: true
    asserts:
      - hasDocuments:
          count: 4
      - isKind:
          of: PersistentVolumeClaim
        documentIndex: 3
  - it: should have a default syslog image
    set:
      global.registry: my-registry
      logReceiver.create: true
    asserts:
    - matchRegex:
        path: spec.template.spec.containers[0].image
        pattern: my-registry/rsyslog:.*
    - equal:
        path: spec.template.spec.containers[0].imagePullPolicy
        value: Always
  - it: should allow configuration of syslog image
    set:
      global.registry: my-registry
      logReceiver.create: true
      logReceiver.image.repository: my-syslog
      logReceiver.image.tag: latest
      logReceiver.image.pullPolicy: IfNotPresent
    asserts:
    - equal:
        path: spec.template.spec.containers[0].image
        value: my-registry/my-syslog:latest
    - equal:
        path: spec.template.spec.containers[0].imagePullPolicy
        value: IfNotPresent
