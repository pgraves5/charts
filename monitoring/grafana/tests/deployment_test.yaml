#
# Copyright Â© [2020] Dell Inc. or its subsidiaries.
# All Rights Reserved.
#
# This software contains the intellectual property of Dell Inc.
# or is licensed to Dell Inc. from third parties. Use of this
# software and the intellectual property contained therein is expressly
# limited to the terms and conditions of the License Agreement under which
# it is provided by or on behalf of Dell Inc. or its subsidiaries.
#
#

suite: test deployment
templates:
  - deployment.yaml
tests:
  - it: tls enabled
    set:
      global.tls_enabled: true
    asserts:
      - contains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            mountPath: /etc/nginx/cert
            name: cert
      - contains:
          path: spec.template.spec.volumes
          content:
            name: cert
            configMap:
              name: RELEASE-NAME-cert
      - equal:
          path: spec.template.spec.containers[1].livenessProbe
          value:
            httpGet:
              path: /api/health
              port: api
              scheme: HTTPS
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 30
            failureThreshold: 3
      - equal:
          path: spec.template.spec.containers[1].readinessProbe
          value:
            httpGet:
              path: /api/health
              port: api
              scheme: HTTPS
            initialDelaySeconds: 5
            periodSeconds: 60
            timeoutSeconds: 30
            failureThreshold: 3
      - contains:
          path: spec.template.spec.volumes
          content:
            name: nginx-config
            configMap:
              name: RELEASE-NAME-grafana-nginx
  - it: tls disabled
    set:
      global.tls_enabled: false
    asserts:
      - notContains:
          path: spec.template.spec.containers[1].volumeMounts
          content:
            mountPath: /etc/nginx/cert
            name: cert
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: cert
            configMap:
              name: RELEASE-NAME-cert
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            httpGet:
              path: /api/health
              port: api
              scheme: HTTP
            initialDelaySeconds: 30
            periodSeconds: 60
            timeoutSeconds: 30
            failureThreshold: 3
      - equal:
          path: spec.template.spec.containers[0].readinessProbe
          value:
            httpGet:
              path: /api/health
              port: api
              scheme: HTTP
            initialDelaySeconds: 5
            periodSeconds: 60
            timeoutSeconds: 30
            failureThreshold: 3
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: nginx-config
            configMap:
              name: RELEASE-NAME-grafana-nginx
  - it: oauth enabled
    set:
      config.oauth.enabled: true
      global.tls_enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].envFrom
          value:
            - secretRef:
                name: RELEASE-NAME-grafana-oauth
  - it: oauth disabled
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].envFrom
  - it: monitoring registry
    set:
      global.registry: ecs_registry
      global.monitoring_registry: mon_registry
      global.monitoring_tag: 1.1
      global.tls_enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: mon_registry/grafana:1.1
      - equal:
          path: spec.template.spec.containers[1].image
          value: mon_registry/nginx:1.1
  - it: ecs registry
    set:
      global.registry: ecs_registry
      global.monitoring_tag: 1.1
      global.tls_enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: ecs_registry/grafana:1.1
      - equal:
          path: spec.template.spec.containers[1].image
          value: ecs_registry/nginx:1.1
  - it: rsyslog client sidecar with objectscale rsyslog
    set:
      global.rsyslog_enabled: true
      global.logging_injection_enabled: false
      global.tls_enabled: true
      global.objectscale_release_name: objectscale-release
      global.objectscale_namespace: objectscale-ns
    asserts:
      - equal:
          path: spec.template.spec.containers[2].name
          value: rsyslog
      - contains:
          path: spec.template.spec.volumes
          content:
            name: rsyslog-config
            configMap:
              name: RELEASE-NAME-rsyslog-client-config
      - contains:
          path: spec.template.spec.containers[2].env
          content:
              name: RSYSLOG_CLIENT
              value: "true"
      - contains:
          path: spec.template.spec.containers[2].env
          content:
            name: RSYSLOG_SVC_NAME
            value: objectscale-release-rsyslog
      - contains:
          path: spec.template.spec.containers[2].env
          content:
            name: RSYSLOG_SVC_NAMESPACE
            value: objectscale-ns
      - isNull:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject
      - isNull:
          path: spec.template.metadata.annotations
  - it: rsyslog client sidecar with local rsyslog
    set:
      global.rsyslog_enabled: true
      global.logging_injection_enabled: false
      global.tls_enabled: true
    asserts:
      - equal:
          path: spec.template.spec.containers[2].name
          value: rsyslog
      - contains:
          path: spec.template.spec.volumes
          content:
            name: rsyslog-config
            configMap:
              name: RELEASE-NAME-rsyslog-client-config
      - contains:
          path: spec.template.spec.containers[2].env
          content:
            name: RSYSLOG_CLIENT
            value: "true"
      - contains:
          path: spec.template.spec.containers[2].env
          content:
            name: RSYSLOG_SVC_NAME
            value: RELEASE-NAME-rsyslog
      - contains:
          path: spec.template.spec.containers[2].env
          content:
            name: RSYSLOG_SVC_NAMESPACE
            value: NAMESPACE
      - isNull:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject
      - isNull:
          path: spec.template.metadata.annotations
  - it: rsyslog client sidecar when disabled
    set:
      global.rsyslog_enabled: false
      global.tls_enabled: true
    asserts:
      - notEqual:
          path: spec.template.spec.containers[2].name
          value: rsyslog
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: rsyslog-config
            configMap:
              name: RELEASE-NAME-rsyslog-client-config
      - isNull:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject
      - isNull:
          path: spec.template.metadata.annotations
  - it: logging injection enabled rsyslog enabled
    set:
      global.rsyslog_enabled: true
      global.logging_injection_enabled: true
    asserts:
      - equal:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject
          value: "true"
      - equal:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject-logrotate
          value: "true"
      - isNull:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject-rsyslog
      - equal:
          path: spec.template.metadata.labels.app\.kubernetes\.io/namespace
          value: "NAMESPACE"
      - equal:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-release-name
          value: "RELEASE-NAME"
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: rsyslog-config
            configMap:
              name: RELEASE-NAME-rsyslog-client-config
  - it: logging injection enabled rsyslog disabled
    set:
      global.rsyslog_enabled: false
      global.logging_injection_enabled: true
    asserts:
      - equal:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject
          value: "true"
      - equal:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject-logrotate
          value: "true"
      - equal:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-inject-rsyslog
          value: "false"
      - equal:
          path: spec.template.metadata.labels.app\.kubernetes\.io/namespace
          value: "NAMESPACE"
      - equal:
          path: spec.template.metadata.labels.objectscale\.dellemc\.com/logging-release-name
          value: "RELEASE-NAME"
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: rsyslog-config
            configMap:
              name: RELEASE-NAME-rsyslog-client-config
---
suite: test replicas
templates:
  - deployment.yaml
tests:
  - it: Started
    asserts:
      - equal:
          path: spec.replicas
          value: 1
  - it: Stopped
    set:
      global.started: false
    asserts:
      - equal:
          path: spec.replicas
          value: 0
